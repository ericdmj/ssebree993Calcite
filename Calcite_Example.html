<html>

<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="initial-scale=1, maximum-scale=1, user-scalable=no" />
  <title>Calcite Components: Create a mapping app</title>

  <script src="https://js.arcgis.com/calcite-components/2.13.0/calcite.esm.js" type="module"></script>
  <link rel="stylesheet" href="https://js.arcgis.com/calcite-components/2.13.0/calcite.css" />

  <script src="https://js.arcgis.com/4.30/"></script>
  <link rel="stylesheet" href="https://js.arcgis.com/4.30/esri/themes/light/main.css" />
</head>
<style>
  html,
  body,
  #viewDiv {
    padding: 0;
    margin: 0;
    height: 100%;
    width: 100%;
  }


  body {
    display: flex;
  }

  calcite-loader {
    align-self: center;
    justify-self: center;
  }

  #info-content {
    padding: 0.75rem;
  }

  calcite-rating {
    margin-top: 0.25rem;
  }
</style>

<body>
  <calcite-loader></calcite-loader>
  <calcite-shell content-behind hidden>
    <calcite-navigation slot="header">
      <calcite-navigation-logo id="header-title" heading-level="1" slot="logo">
        <!-- Dynamically populated -->
      </calcite-navigation-logo>
    </calcite-navigation>

    <calcite-shell-panel slot="panel-start" display-mode="float">
      <calcite-action-bar slot="action-bar">
        <calcite-action data-action-id="about" icon="asterisk-large" text="About"></calcite-action>
        <calcite-action data-action-id="survey" icon="plus-circle" text="Add Kolache location"></calcite-action>
        <calcite-action data-action-id="layers" icon="layers" text="Layers"></calcite-action>
        <calcite-action data-action-id="basemaps" icon="basemap" text="Basemaps"></calcite-action>
        <calcite-action data-action-id="legend" icon="legend" text="Legend"></calcite-action>
        <calcite-action data-action-id="information" icon="information" text="Information"></calcite-action>
        <calcite-action data-action-id="attribution" icon="attributions-container" text="Attribution"></calcite-action>
      </calcite-action-bar>

      <!-- Map-specific panels (each one provides a div for a ArcGIS Maps SDK for JavaScript widget) -->
      <calcite-panel heading="About" height-scale="l" data-panel-id="about" hidden>
        <div id="about-container"></div>
      </calcite-panel>
      <calcite-panel heading="Add a Kolache location" height-scale="l" data-panel-id="survey" hidden>
        <div id="survey-container"></div>
      </calcite-panel>
      <calcite-panel heading="Layers" height-scale="l" data-panel-id="layers" hidden>
        <div id="layers-container"></div>
      </calcite-panel>
      <calcite-panel heading="Basemaps" height-scale="l" data-panel-id="basemaps" hidden>
        <div id="basemaps-container"></div>
      </calcite-panel>
      <calcite-panel heading="Legend" height-scale="l" data-panel-id="legend" hidden>
        <div id="legend-container"></div>
      </calcite-panel>
      <calcite-panel heading="Attribution" height-scale="l" data-panel-id="attribution" hidden>
        <div id="attributions-container"></div>
      </calcite-panel>

      <!-- Add a Kolache panel -->
        <calcite-panel height-scale="l" heading="Add a Kolache location" data-panel-id="addDragon" hidden>
                <div id="survey-container">
                  <h4 style="margin-top:0;">Submission Guidelines:</h4>
                  <p>Click the button below to contribute a kolache to the kolache database. This will open a new page with Survey123. Please follow the guided survey with a submission.</p>
                  <div style="display:flex; margin: 1rem 1rem;">
            <calcite-button href="https://arcg.is/9Pmm9" icon-end="launch" label="Open Kolache Database Survey123 Link" target="_blank" style="margin:auto;"> Open Dragon Database Survey
            </calcite-button>
            </div>
        </div>
      </calcite-panel>

      <!-- Info panel (populates with info from the web map) -->
      <calcite-panel heading="Details" data-panel-id="information" hidden>
        <div id="info-content">
          <img id="item-thumbnail" alt="webmap thumbnail" />
          <div id="item-description">
            <!-- Dynamically populated -->
          </div>
          <calcite-label layout="inline">
            <b>Rating:</b>
            <calcite-rating id="item-rating" read-only>
              <!-- Dynamically populated -->
            </calcite-rating>
          </calcite-label>
        </div>
      </calcite-panel>
    </calcite-shell-panel>
    <div id="viewDiv"></div>
  </calcite-shell>
</body>
<script>
  require([
    "esri/WebMap",
    "esri/views/MapView",
    "esri/widgets/BasemapGallery",
    "esri/widgets/LayerList",
    "esri/widgets/Legend",
    "esri/widgets/Attribution",
    "esri/widgets/Search",
  ], function (WebMap, MapView,BasemapGallery, LayerList, Legend, Attribution, Search) {
    const webmapId = new URLSearchParams(window.location.search).get("webmap") ?? "bd1fdb61c213433a8c5569f6520d40a3";

    const map = new WebMap({
      portalItem: {
        id: webmapId
      }
    });

    const view = new MapView({
      map,
      container: "viewDiv",
      padding: {
        left: 49
      }
    });

    view.ui.move("zoom", "top-left");

    // fix this with the correct widget and panel information
    // rename CREDITS
    //const about = new About({
      //view,
      //container: "about-container"
    //});

    // fix this with the correct hyperlink
      //const survey = new Survey({
      //view,
      //container: "survey-container"
    //});

    const basemaps = new BasemapGallery({
      view,
      container: "basemaps-container"
    });

    const layerList = new LayerList({
      view,
      dragEnabled: true,
      visibilityAppearance: "checkbox",
      container: "layers-container"
    });

    const legend = new Legend({
      view,
      container: "legend-container"
    });

    const attribution = new Attribution({
      view,
      container: "attributions-container"
    });

    map.when(() => {
      const { title, description, thumbnailUrl, avgRating } = map.portalItem;
      document.querySelector("#header-title").heading = title;
      document.querySelector("#item-description").innerHTML = description;
      document.querySelector("#item-thumbnail").src = thumbnailUrl;
      document.querySelector("#item-rating").value = avgRating;

      let activeWidget;

      const handleActionBarClick = ({ target }) => {
        if (target.tagName !== "CALCITE-ACTION") {
          return;
        }

        if (activeWidget) {
          document.querySelector(`[data-action-id=${activeWidget}]`).active = false;
          document.querySelector(`[data-panel-id=${activeWidget}]`).hidden = true;
        }

        const nextWidget = target.dataset.actionId;
        if (nextWidget !== activeWidget) {
          document.querySelector(`[data-action-id=${nextWidget}]`).active = true;
          document.querySelector(`[data-panel-id=${nextWidget}]`).hidden = false;
          activeWidget = nextWidget;
        } else {
          activeWidget = null;
        }
      };
      // Event listener for the action bar
      document.querySelector("calcite-action-bar").addEventListener("click", handleActionBarClick);

      let actionBarExpanded = false;

      document.addEventListener("calciteActionBarToggle", event => {
        actionBarExpanded = !actionBarExpanded;
        view.padding = {
          left: actionBarExpanded ? 150 : 49
        };
      });

      document.querySelector("calcite-shell").hidden = false;
      document.querySelector("calcite-loader").hidden = true;

    });
  });
</script>

</html>